flash_att_commit := d478eeec8f16c7939c54e4617dbd36f59b8eeed7

flash-attention:
    # Install specific version of flash attention
	pip install packaging
	git clone https://github.com/HazyResearch/flash-attention.git
	cd flash-attention && git checkout $(flash_att_commit)

flash-attention/build: flash-attention
	cd flash-attention && git checkout $(flash_att_commit)
	cd flash-attention && python setup.py build

flash-attention/csrc/layer_norm/build: flash-attention
	cd flash-attention && git checkout $(flash_att_commit)
	cd flash-attention/csrc/layer_norm && python setup.py build

flash-attention/csrc/rotary/build: flash-attention
	cd flash-attention && git checkout $(flash_att_commit)
	cd flash-attention/csrc/rotary && python setup.py build

build-flash-attention: flash-attention/build flash-attention/csrc/layer_norm/build flash-attention/csrc/rotary/build

install-flash-attention: build-flash-attention
	pip uninstall flash_attn rotary_emb dropout_layer_norm -y || true
	cd flash-attention && python setup.py install && cd csrc/layer_norm && python setup.py install && cd ../rotary && python setup.py install